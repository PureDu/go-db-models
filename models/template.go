package models

const (
	// 生成的数据表的文件的模版: gen_table_*.go
	codeTemplate = `// DON'T EDIT *** generated by go-db-models *** DON'T EDIT //

package {{.PackageName}}

{{range $k, $v := .Imports}}
import "{{$v}}"{{end}}
import "strings"
import "database/sql"

// 对应数据表：{{.Name}}{{if .Msg}}
// {{.Msg}}{{end}}
type {{.Name|Format2StructName}}Table struct { 
{{range $k, $v := .Fields}}
{{$v.Name|Format2StructName}}  {{$v.Type}} {{$v.Name|Format2StructTag}}{{end}}
}

const {{.Name|Format2Title}}SelectFields string = " {{.SelectFields}} "

{{if .QueryBy.FieldName}}
// 根据{{.QueryBy.FieldName}}字段查询单行记录
func {{.Name|Format2StructName}}QueryBy{{.QueryBy.FieldName|Format2StructName}}(db *sql.DB, {{.QueryBy.FieldName|Format2Title}}Val {{.QueryBy.FieldType}}) ({{.Name}} *{{.Name|Format2StructName}}Table, err error) {
	queryString := "SELECT " + {{.Name|Format2Title}}SelectFields + " FROM {{.Name|AddBackquote}} WHERE {{.QueryBy.FieldName|AddBackquote}} = ?"
	{{.Name}} = &{{.Name|Format2StructName}}Table{}
	err = db.QueryRow(queryString, {{.QueryBy.FieldName|Format2Title}}Val).Scan( {{range $k, $v := .Fields}}
		&{{$.Name}}.{{$v.Name|Format2StructName}},{{end}}
	)

	if err != nil {
		return nil, err
	}

	return {{.Name}}, nil
}
{{end}}

// 根据where条件查询单行记录
func {{.Name|Format2StructName}}QueryRowWhere(db *sql.DB, where string) ({{.Name}} *{{.Name|Format2StructName}}Table, err error) {
	queryString := "SELECT " + {{.Name|Format2Title}}SelectFields + " FROM {{.Name|AddBackquote}} WHERE " + where
	return do{{.Name|Format2StructName}}QueryRow(db, queryString)
}

// 查询单行记录
func {{.Name|Format2StructName}}QueryRow(db *sql.DB, queryString string) ({{.Name}} *{{.Name|Format2StructName}}Table, err error) {
	queryString = strings.Replace(queryString, SelectFieldsTemp, {{.Name|Format2Title}}SelectFields, 1)
	return do{{.Name|Format2StructName}}QueryRow(db, queryString)
}

// 查询单行记录（内部调用）
func do{{.Name|Format2StructName}}QueryRow(db *sql.DB, queryString string) ({{.Name}} *{{.Name|Format2StructName}}Table, err error) {
	{{.Name}} = &{{.Name|Format2StructName}}Table{}
	err = db.QueryRow(queryString).Scan( {{range $k, $v := .Fields}}
		&{{$.Name}}.{{$v.Name|Format2StructName}},{{end}}
	)

	if err != nil {
		return nil, err
	}

	return {{.Name}}, nil
}

// 根据where条件查询多行记录
// 如果查询所有记录，只需要where="1"
func {{.Name|Format2StructName}}QueryWhere(db *sql.DB, where string) ({{.Name}} {{if .MapIndex.Name}}map[{{.MapIndex.Type}}]*{{.Name|Format2StructName}}Table{{else}}[]*{{.Name|Format2StructName}}Table{{end}}, err error) {
	queryString := "SELECT " + {{.Name|Format2Title}}SelectFields + " FROM {{.Name|AddBackquote}} WHERE " + where
	return do{{.Name|Format2StructName}}Query(db, queryString)
}

// 根据sql语句查询多行记录
// 外部使用时，SQL语句应该这样写：
//   select {select-fields-temp} from ad_plan where status = 1
// 其中{select-fields-temp}会自动替换为相应的字段名
func {{.Name|Format2StructName}}Query(db *sql.DB, queryString string) ({{.Name}} {{if .MapIndex.Name}}map[{{.MapIndex.Type}}]*{{.Name|Format2StructName}}Table{{else}}[]*{{.Name|Format2StructName}}Table{{end}}, err error) {
	queryString = strings.Replace(queryString, SelectFieldsTemp, {{.Name|Format2Title}}SelectFields, 1)
	return do{{.Name|Format2StructName}}Query(db, queryString)
}

// 查询多行记录（内部调用）
func do{{.Name|Format2StructName}}Query(db *sql.DB, queryString string) ({{.Name}} {{if .MapIndex.Name}}map[{{.MapIndex.Type}}]*{{.Name|Format2StructName}}Table{{else}}[]*{{.Name|Format2StructName}}Table{{end}}, err error) {
	rows, err := db.Query(queryString)
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	for rows.Next() {
		var oneRow = &{{.Name|Format2StructName}}Table{}
		err = rows.Scan( {{range $k, $v := .Fields}}
			&oneRow.{{$v.Name|Format2StructName}},{{end}}
		)
		if err != nil {
			return nil, err
		}

		{{if .MapIndex.Name}}
		{{.Name}}[oneRow.{{.MapIndex.Name|Format2StructName}}] = oneRow
		{{else}}
		{{.Name}} = append({{.Name}}, oneRow)
		{{end}}
	}

	return {{.Name}}, nil
}
`
	// 生成的gen_common.go文件的模版
	commonCodeTemplate = `// DON'T EDIT *** generated by go-db-models *** DON'T EDIT //
	
package {{.PackageName}}

const (
	// sql语句中，可以使用该字符串来表示需要查询的字段名
	// 执行时会自动替换为相应的需要查询的字段名
	SelectFieldsTemp string = "{select-fields-temp}"
)
`
)
